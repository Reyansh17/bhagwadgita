export const createTraceListener=(e,n)=>s=>{let r=s.id;if("request"===s.event&&"begin"===s.type){let a=()=>{let e,n;let s=-1,r=[],a=[],t=!1,o=new Promise(n=>{e=e=>{t||(t=!0,n(e))}}),i=!1,c=new Promise(e=>{n=n=>{if(!i){for(i=!0,-1===s&&(s=0);s<a.length;s++){let e;let n={name:"anonymous",time:performance.now(),skip:!0,end:new Promise(n=>{n(e)}),children:[]};e=performance.now(),r[s](n)}e(n)}}});return{signal:o,consumeChild(e){switch(e.type){case"begin":r[++s]({name:e.name,time:e.time,skip:!1,end:new Promise(e=>{a.push(e)})});break;case"end":a[s](e.time)}},consume(s){switch(s.type){case"begin":let a=[],t=s.unit??0;for(let e=0;e<t;e++){let e;a.push(new Promise(n=>{e=n})),r.push(e)}e({// Begin always have name
    name:s.name,time:s.time,skip:!1,end:c,children:a});break;case"end":n(s.time)}},resolve(){let s;if(t&&i)return;let r={name:"anonymous",time:performance.now(),skip:!0,end:new Promise(e=>{e(s)}),children:[]};s=performance.now(),e(r),n(s)}}},t=a(),o=a(),i=a(),c=a(),l=a(),m=a(),u=a(),d=a();t.consume(s);let b=n=>{if(n.id===r)switch(n.event){case"request":t.consume(n);break;case"request.unit":t.consumeChild(n);break;case"parse":o.consume(n);break;case"parse.unit":o.consumeChild(n);break;case"transform":i.consume(n);break;case"transform.unit":i.consumeChild(n);break;case"beforeHandle":c.consume(n);break;case"beforeHandle.unit":c.consumeChild(n);break;case"handle":l.consume(n);break;case"afterHandle":m.consume(n);break;case"afterHandle.unit":m.consumeChild(n);break;case"error":u.consume(n);break;case"error.unit":u.consumeChild(n);break;case"response":"begin"===n.type?(t.resolve(),o.resolve(),i.resolve(),c.resolve(),l.resolve(),m.resolve(),u.resolve()):e.off("event",b),d.consume(n);break;case"response.unit":d.consumeChild(n)}};e.on("event",b),n({id:s.id,// @ts-ignore
    context:s.ctx,// @ts-ignore
    set:s.ctx?.set,// @ts-ignore
    store:s.ctx?.store,time:s.time,request:t.signal,parse:o.signal,transform:i.signal,beforeHandle:c.signal,handle:l.signal,afterHandle:m.signal,error:u.signal,response:d.signal})}};