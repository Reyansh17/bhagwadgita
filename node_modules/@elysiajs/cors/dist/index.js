export const cors = ({ origin = true, methods = '*', allowedHeaders = '*', exposedHeaders = '*', credentials = false, maxAge = 5, preflight = true } = {
    origin: true,
    methods: '*',
    allowedHeaders: '*',
    exposedHeaders: '*',
    credentials: false,
    maxAge: 5,
    preflight: true
}) => (app) => {
    const origins = typeof origin === 'boolean'
        ? undefined
        : Array.isArray(origin)
            ? origin
            : [origin];
    const processOrigin = (origin, request, from) => {
        switch (typeof origin) {
            case 'string':
                return origin;
            case 'function':
                return origin(request);
            case 'object':
                if (origin.test(from))
                    return true;
        }
    };
    const handleOrigin = (set, request) => {
        if (origin === true) {
            set.headers['Vary'] = '*';
            set.headers['Access-Control-Allow-Origin'] = '*';
            return;
        }
        if (!origins?.length)
            return;
        const headers = [];
        if (origins.length) {
            const from = request.headers.get('Origin') ?? '';
            for (let i = 0; i < origins.length; i++) {
                const value = processOrigin(origins[i], request, from);
                if (value === true) {
                    set.headers['Vary'] = origin ? 'Origin' : '*';
                    set.headers['Access-Control-Allow-Origin'] =
                        request.headers.get('Origin') ?? '*';
                    return;
                }
                if (value)
                    headers.push(value);
            }
        }
        set.headers['Vary'] = 'Origin';
        set.headers['Access-Control-Allow-Origin'] = headers.join(', ');
    };
    const handleMethod = (set) => {
        if (!methods?.length)
            return;
        if (methods === '*')
            return (set.headers['Access-Control-Allow-Methods'] = '*');
        if (!Array.isArray(methods))
            return (set.headers['Access-Control-Allow-Methods'] = methods);
        set.headers['Access-Control-Allow-Methods'] = methods.join(', ');
    };
    if (preflight)
        app.options('/', ({ set, request }) => {
            handleOrigin(set, request);
            handleMethod(set);
            if (exposedHeaders.length)
                set.headers['Access-Control-Allow-Headers'] =
                    typeof allowedHeaders === 'string'
                        ? allowedHeaders
                        : allowedHeaders.join(', ');
            if (maxAge)
                set.headers['Access-Control-Max-Age'] = maxAge.toString();
            return new Response('', {
                status: 204
            });
        }).options('/*', ({ set, request }) => {
            handleOrigin(set, request);
            handleMethod(set);
            if (exposedHeaders.length)
                set.headers['Access-Control-Allow-Headers'] =
                    typeof allowedHeaders === 'string'
                        ? allowedHeaders
                        : allowedHeaders.join(', ');
            if (maxAge)
                set.headers['Access-Control-Max-Age'] = maxAge.toString();
            return new Response('', {
                status: 204
            });
        });
    return app.onRequest(({ set, request }) => {
        handleOrigin(set, request);
        handleMethod(set);
        if (allowedHeaders.length)
            set.headers['Access-Control-Allow-Headers'] =
                typeof allowedHeaders === 'string'
                    ? allowedHeaders
                    : allowedHeaders.join(', ');
        if (exposedHeaders.length)
            set.headers['Access-Control-Exposed-Headers'] =
                typeof exposedHeaders === 'string'
                    ? exposedHeaders
                    : exposedHeaders.join(', ');
        if (credentials)
            set.headers['Access-Control-Allow-Credentials'] = 'true';
    });
};
export default cors;
